<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Retourbewijs & Retourlabel – Print (CO-RE, NL/FR, handtekeningen)</title>
  <style>
    :root{
      --w:210mm; --h:297mm; --pad:14mm;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    html,body{margin:0;padding:0;font-family:var(--font);color:#000;background:#f7f7f7}
    .app{max-width:960px;margin:24px auto;padding:16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04);background:#fff}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>label{flex:1 1 260px;display:flex;flex-direction:column;font-size:14px}
    input,select,textarea{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:16px}
    textarea{min-height:80px}
    .actions{display:flex;gap:12px;align-items:center;margin-top:16px;flex-wrap:wrap}
    .btn{background:#111;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer}
    .hint{font-size:12px;color:#555}

    /* Signature pads */
    .sigrow{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .sigwrap{flex:1 1 380px;display:flex;flex-direction:column;gap:8px}
    .sigpad{border:1px solid #ccc;border-radius:8px;background:#fff;touch-action:none;width:100%;height:150px}
    .btn.small{padding:8px 10px;font-size:12px;border-radius:8px;background:#444}

    /* Print surface */
    .page{position:relative;width:var(--w);height:var(--h);page-break-after:always;background:#fff;overflow:hidden}
    .content{position:absolute;left:var(--pad);right:var(--pad);top:var(--pad)}
    .h1{font-size:20pt;font-weight:700;margin:0 0 10mm 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:6mm 12mm;font-size:12pt}
    .label{font-weight:700;margin-right:6px}
    .field{border-bottom:1px solid #000;padding:2mm 0;min-height:14pt}
    .subtext{font-size:10pt;margin-top:8mm;line-height:1.35}
    .signs{display:grid;grid-template-columns:1fr 1fr;gap:12mm;margin-top:8mm}
    .sign{border-top:1px solid #000;padding-top:4mm;text-align:center;font-size:10pt}

    /* Large CO-RE label occupying most of top half */
    .label-stack{
      position:absolute; top:18mm; left:50%; transform:translateX(-50%);
      width: calc(210mm - 2 * var(--pad)); max-width: 182mm; text-align:center; line-height:1.02;
      overflow:hidden;
    }
    .label-stack .core{
      font-size: 150pt; /* ~53mm cap height */
      font-weight: 900; letter-spacing: 4pt; margin: 0;
      white-space: nowrap; word-break: keep-all;
    }
    .label-note{position:absolute;left:10mm;bottom:10mm;font-size:10pt;opacity:.75}

    @media print {
      body{background:#fff}
      .app{display:none}
      @page { size: A4; margin: 10mm; }
    }
  </style>
</head>
<body>
  <div class="app card">
    <h2 style="margin-top:0">Retourbewijs + Retourlabel printen / Imprimer récépissé + étiquette de retour</h2>
    <p class="hint">
      Kies de taal, vul de gegevens in en klik op <b>Print / Imprimer</b>. Er worden automatisch <b>3</b> ontvangstbewijzen (klant/bij retourzending/winkeladministratie) en <b>1</b> retourlabel geprint.<br>
      Choisissez la langue, complétez les données et cliquez sur <b>Print / Imprimer</b>. Cela imprimera automatiquement <b>3</b> accusés de réception (client / avec le retour / administration du magasin) et <b>1</b> étiquette de retour.
    </p>

    <div class="row">
      <label>Taal / Langue
        <select id="lang">
          <option value="nl" selected>Nederlands</option>
          <option value="fr">Français</option>
        </select>
      </label>
      <label>Datum / Date
        <input id="date" type="date" />
      </label>
      <label>Contractnummer / N° de contrat
        <input id="contract" type="text" />
      </label>
      <label>Winkelnummer / N° de magasin
        <input id="store" type="text" />
      </label>
      <label>Klantnummer / N° client
        <input id="customer" type="text" />
      </label>
      <label>Peros order nummers / N° de commande Peros
        <textarea id="orders" placeholder="b.v. 12345, 67890 / ex. 12345, 67890"></textarea>
      </label>
    </div>

    <div class="row">
      <label>Aantal ontvangstbewijzen (standaard 3) / Nb d'accusés (3 par défaut)
        <input id="copiesReceipt" type="number" min="1" value="3" />
      </label>
      <label>Aantal labels (standaard 1) / Nb d'étiquettes (1 par défaut)
        <input id="copiesLabel" type="number" min="0" value="1" />
      </label>
    </div>

    <!-- Signature pads -->
    <div class="sigrow">
      <div class="sigwrap">
        <label>Handtekening klant / Signature client</label>
        <canvas id="sigCustomer" class="sigpad"></canvas>
        <button type="button" class="btn small" id="clearCust">Wissen / Effacer</button>
      </div>
      <div class="sigwrap">
        <label>Handtekening winkel / Signature magasin</label>
        <canvas id="sigStore" class="sigpad"></canvas>
        <button type="button" class="btn small" id="clearStore">Wissen / Effacer</button>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="printBtn">Print / Imprimer</button>
    </div>
  </div>

  <!-- Auto-fill today's date safely -->
  <script>
  (function(){
    var dateField = document.getElementById('date');
    if (dateField && !dateField.value) {
      var today = new Date();
      var yyyy = today.getFullYear();
      var mm = String(today.getMonth() + 1).padStart(2, '0');
      var dd = String(today.getDate()).padStart(2, '0');
      dateField.value = yyyy + '-' + mm + '-' + dd;
    }
  })();
  </script>

  <!-- Signature pads setup (no storage, in-memory only) -->
  <script>
  (function(){
    function setupPad(id, clearBtnId){
      const c = document.getElementById(id), ctx = c.getContext('2d');
      let drawing=false, last=null, snapshot=null;
      function resize(){
        const ratio = Math.max(window.devicePixelRatio||1,1);
        const rect = c.getBoundingClientRect();
        c.width = Math.round(rect.width*ratio);
        c.height = Math.round(rect.height*ratio);
        ctx.setTransform(ratio,0,0,ratio,0,0);
        ctx.lineWidth = 2; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#000';
        ctx.clearRect(0,0,rect.width,rect.height);
      }
      function pos(e){ const r=c.getBoundingClientRect(); return {x:(e.clientX-r.left), y:(e.clientY-r.top)};}
      function drawDot(p){ ctx.beginPath(); ctx.arc(p.x, p.y, 0.5, 0, Math.PI*2); ctx.fillStyle='#000'; ctx.fill(); }
      function down(e){ e.preventDefault(); drawing=true; last=pos(e); drawDot(last); }
      function move(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; }
      function up(){ if(!drawing) return; drawing=false; snapshot = c.toDataURL('image/png'); }
      c.addEventListener('pointerdown',down);
      c.addEventListener('pointermove',move);
      window.addEventListener('pointerup',up);
      document.getElementById(clearBtnId).addEventListener('click', ()=>{ const r=c.getBoundingClientRect(); ctx.clearRect(0,0,r.width,r.height); snapshot=null; resize(); });
      new ResizeObserver(resize).observe(c);
      return {
        get: ()=> snapshot || c.toDataURL('image/png'),
        finalize: ()=> { up(); snapshot = c.toDataURL('image/png'); }
      };
    }
    window._sigPads = {
      customer: setupPad('sigCustomer','clearCust'),
      store:    setupPad('sigStore','clearStore')
    };
    window.addEventListener('beforeunload', ()=>{
      document.getElementById('clearCust').click();
      document.getElementById('clearStore').click();
    });
  })();
  </script>

  <!-- Main app & print -->
  <script>
    const I18N = {
      nl: {
        title: 'Ontvangstbewijs',
        p1: 'Wij bevestigen de ontvangst van de gehuurde producten. De eventuele betalingsverplichting van de openstaande bedragen en additionele kosten komen hiermee niet te vervallen. Wij verwijzen u voor meer informatie naar artikel 9 van de algemene voorwaarden Pearle Bril Plan.',
        date: 'Datum', contract:'Contractnummer', store:'Winkelnummer', customer:'Klantnummer', orders:'Peros order nummers',
        sigCustomer:'Handtekening klant', sigStore:'Handtekening winkel',
        labelNote:'Retourlabel – steek deze zichtbaar bij de retour'
      },
      fr: {
        title: 'Accusé de réception',
        p1: "Nous confirmons la réception des produits loués. L'obligation de paiement des montants ouverts et des frais supplémentaires n'est pas annulée. Pour plus d'informations, voir l'article 9 des conditions générales du Pearle Bril Plan.",
        date: 'Date', contract:'N° de contrat', store:'N° de magasin', customer:'N° client', orders:'N° de commande Peros',
        sigCustomer:'Signature client', sigStore:'Signature magasin',
        labelNote:'Étiquette de retour – placez-la bien visible avec le retour'
      }
    };
    const $ = (id)=>document.getElementById(id);

    function collect(){
      return {
        lang: $('lang').value,
        date: $('date').value ? new Date($('date').value).toLocaleDateString($('lang').value==='fr'?'fr-BE':'nl-BE') : '',
        contract: $('contract').value.trim(),
        store: $('store').value.trim(),
        customer: $('customer').value.trim(),
        orders: $('orders').value.trim(),
        copiesReceipt: Math.max(1, parseInt($('copiesReceipt').value||'3',10)),
        copiesLabel: Math.max(0, parseInt($('copiesLabel').value||'1',10)),
        sigCustomer: window._sigPads.customer.get(),
        sigStore: window._sigPads.store.get()
      };
    }

    function openPrintWindow(values, autoPrint){
      const w = window.open('', '_blank');
      if(!w){ alert('Pop-up geblokkeerd. Sta pop-ups toe voor deze site. / Fenêtre bloquée. Autorisez les pop-ups.'); return; }
      const L = I18N[values.lang];
      const d = w.document;

      // Base skeleton
      d.open();
      d.write('<!doctype html><html><head><meta charset="utf-8"><title>Print – Retour</title></head><body></body></html>');
      d.close();

      // Styles (same look as app)
      const style = d.createElement('style');
      style.textContent = `@page{size:A4;margin:10mm}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#000}
        .page{position:relative;width:210mm;height:297mm;page-break-after:always;background:#fff;overflow:hidden}
        .content{position:absolute;left:14mm;right:14mm;top:14mm}
        .h1{font-size:20pt;font-weight:700;margin:0 0 10mm 0}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:6mm 12mm;font-size:12pt}
        .label{font-weight:700;margin-right:6px}
        .field{border-bottom:1px solid #000;padding:2mm 0;min-height:14pt}
        .subtext{font-size:10pt;margin-top:8mm;line-height:1.35}
        .signs{display:grid;grid-template-columns:1fr 1fr;gap:12mm;margin-top:8mm}
        .sign{border-top:1px solid #000;padding-top:4mm;text-align:center;font-size:10pt}
        .label-stack{position:absolute;top:18mm;left:50%;transform:translateX(-50%);width:182mm;text-align:center;line-height:1.02;overflow:hidden}
        .label-stack .core{font-size:150pt;font-weight:900;letter-spacing:4pt;margin:0;white-space:nowrap}
        .label-note{position:absolute;left:10mm;bottom:10mm;font-size:10pt;opacity:.75}`;
      d.head.appendChild(style);

      function mk(tag, cls){ const el = d.createElement(tag); if(cls) el.className = cls; return el; }

      function addReceipt(){
        const page = mk('section','page');
        const content = mk('div','content');
        const h1 = mk('h1','h1'); h1.textContent = L.title; content.appendChild(h1);

        const grid = mk('div','grid');
        const addRow = (label, val) => {
          const cell = mk('div');
          const lbl = mk('span','label'); lbl.textContent = label + ': ';
          const field = mk('div','field'); field.textContent = val || '';
          cell.appendChild(lbl); cell.appendChild(field);
          grid.appendChild(cell);
        };
        addRow(L.date, values.date);
        addRow(L.contract, values.contract);
        addRow(L.store, values.store);
        addRow(L.customer, values.customer);

        const ordersCell = mk('div'); ordersCell.style.gridColumn = '1 / span 2';
        const ordersLbl = mk('span','label'); ordersLbl.textContent = L.orders + ': ';
        const ordersField = mk('div','field'); ordersField.textContent = values.orders || '';
        ordersCell.appendChild(ordersLbl); ordersCell.appendChild(ordersField);
        grid.appendChild(ordersCell);

        content.appendChild(grid);
        const p = mk('div','subtext'); p.textContent = L.p1; content.appendChild(p);

        /* Signature images if provided */
        const sigWrap = mk('div'); sigWrap.style.display='grid'; sigWrap.style.gridTemplateColumns='1fr 1fr'; sigWrap.style.gap='12mm'; sigWrap.style.marginTop='8mm';
        const addSig = (dataUrl, alt)=>{
          if(dataUrl){
            const box = mk('div'); const img = mk('img'); img.src=dataUrl; img.alt=alt; img.style.maxHeight='25mm'; img.style.objectFit='contain'; box.appendChild(img); sigWrap.appendChild(box);
          } else { sigWrap.appendChild(mk('div')); }
        };
        addSig(values.sigCustomer, 'Signature client'); addSig(values.sigStore, 'Signature magasin');
        content.appendChild(sigWrap);

        const signs = mk('div','signs');
        const s1 = mk('div','sign'); s1.textContent = L.sigCustomer;
        const s2 = mk('div','sign'); s2.textContent = L.sigStore;
        signs.appendChild(s1); signs.appendChild(s2);
        content.appendChild(signs);

        page.appendChild(content);
        d.body.appendChild(page);
      }

      function addLabel(){
        const page = mk('section','page');
        const stack = mk('div','label-stack');
        const t2 = mk('div','core'); t2.textContent = 'CO-RE';
        stack.appendChild(t2);
        page.appendChild(stack);
        const note = mk('div','label-note'); note.textContent = L.labelNote;
        page.appendChild(note);
        d.body.appendChild(page);
      }

      for(let i=0;i<values.copiesReceipt;i++) addReceipt();
      for(let i=0;i<values.copiesLabel;i++) addLabel();

      function waitForImagesAndFonts(win, cb){
        const doc = win.document;
        const imgs = Array.from(doc.images || []);
        const imgPromises = imgs.map(img => {
          if (img.decode) { return img.decode().catch(()=>{}); }
          if (img.complete && img.naturalWidth !== 0) return Promise.resolve();
          return new Promise(res=>{ img.addEventListener('load', res, {once:true}); img.addEventListener('error', res, {once:true}); });
        });
        const fontsReady = (doc.fonts && doc.fonts.ready) ? doc.fonts.ready.catch(()=>{}) : Promise.resolve();
        Promise.all([...imgPromises, fontsReady]).then(()=>{
          win.requestAnimationFrame(()=>win.requestAnimationFrame(cb));
        });
      }

      if(autoPrint){
        waitForImagesAndFonts(w, ()=>{ w.focus(); w.print(); });
      }
    }

    document.getElementById('printBtn').addEventListener('click', ()=>{
      try { window._sigPads.customer.finalize(); } catch(e){}
      try { window._sigPads.store.finalize(); } catch(e){}
      requestAnimationFrame(()=>{
        openPrintWindow(collect(), true);
      });
    });
  </script>
</body>
</html>
